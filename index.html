<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp"
      rel="stylesheet">
      <link rel="stylesheet" href="styles/style.css">
    <style>
        #winRateGauge {
            background: transparent !important;
        }
        #winRateGauge > div {
            background: transparent !important;
        }
        .apexcharts-canvas {
            background: transparent !important;
        }
    </style>
</head>
<body>
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <div class="container">
        <aside class="top">
            <div class="logo">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="48" height="48" role="img" aria-labelledby="logoTitle logoDesc">
                  <title id="logoTitle">SQU^RE DOFF Trading Dashboard</title>
                  <desc id="logoDesc">Square logo with an upward trending chart line indicating market performance.</desc>
                  <g opacity="0.08" fill="none" class="logo-grid" stroke-width="0.8">
                    <path d="M10 48 L54 48" />
                    <path d="M10 36 L54 36" />
                    <path d="M10 24 L54 24" />
                    <path d="M22 10 L22 54" />
                    <path d="M34 10 L34 54" />
                    <path d="M46 10 L46 54" />
                  </g>
                  <rect x="12" y="36" width="6" height="10" rx="1" class="logo-bar" opacity="0.18" />
                  <rect x="22" y="30" width="6" height="16" rx="1" class="logo-bar" opacity="0.22" />
                  <rect x="32" y="22" width="6" height="24" rx="1" class="logo-bar-active" />
                  <rect x="42" y="16" width="6" height="30" rx="1" class="logo-bar" opacity="0.18" />
                  <polyline points="12,42 20,34 28,26 36,20 44,16" fill="none" class="logo-line" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
                  <circle cx="44" cy="16" r="3.2" class="logo-accent" />
                </svg>
                <h2>SQU^RE<span class="danger">DOFF</span></h2>
            </div>
            <div class="close" id="close-btn" role="button" aria-label="Close sidebar" tabindex="0">
                <span class="material-icons-sharp" aria-hidden="true">close</span>
            </div>

            <nav class="sidebar" role="navigation" aria-label="Main navigation">
                <a href="#" aria-current="page">
                    <span class="material-icons-sharp">grid_view</span>
                    <h3>Dashboard</h3>
                </a>

                <a href="html/news.html">
                    <span class="material-icons-sharp">newspaper</span>
                    <h3>Financial News</h3>
                </a>

                <a href="html/stocks.html">
                    <span class="material-icons-sharp">trending_up</span>
                    <h3>Stocks</h3>
                </a>

                <a href="html/indecescommodities.html">
                    <span class="material-icons-sharp">show_chart</span>
                    <h3>Indices & Commodities</h3>
                </a>

                <a href="html/crypto.html">
                    <span class="material-icons-sharp">currency_bitcoin</span>
                    <h3>Cryptocurrency</h3>
                </a>

                <a href="html/analytics.html">
                    <span class="material-icons-sharp">insights</span>
                    <h3>Analytics</h3>
                </a>

                <a href="html/messages.html">
                    <span class="material-icons-sharp" aria-hidden="true">mail_outline</span>
                    <h3>Messages</h3>
                    <span class="message-count" aria-label="21 unread messages">21</span>
                </a>

                <a href="html/orders.html">
                    <span class="material-icons-sharp">inventory</span>
                    <h3>Orders</h3>
                </a>

                <a href="html/reports.html">
                    <span class="material-icons-sharp">error</span>
                    <h3>Reports</h3>
                </a>

                <a href="html/settings.html">
                    <span class="material-icons-sharp">settings</span>
                    <h3>Settings</h3>
                </a>

                <a href="#">
                    <span class="material-icons-sharp">add</span>
                    <h3>Add Commodity</h3>
                </a>

                <a href="#">
                    <span class="material-icons-sharp">logout</span>
                    <h3>Logout</h3>
                </a>
            </nav>

        </aside>
        <!--((((((((((((((End of Aside Section))))))))))))))-->

        <main id="main-content" role="main" aria-label="Dashboard content">
            <!--Trading View Ticker Tape-->
            <!-- TradingView Widget BEGIN -->
            <div class="tradingview-widget-container" style="margin-bottom: 2rem;">
              <div class="tradingview-widget-container__widget"></div>
              <div class="tradingview-widget-copyright"><a href="https://www.tradingview.com/markets/" rel="noopener nofollow" target="_blank"><span class="blue-text">Ticker tape</span></a><span class="trademark"> by TradingView</span></div>
              <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
              {
              "symbols": [
                {
                  "proName": "FOREXCOM:SPXUSD",
                  "title": "S&P 500 Index"
                },
                {
                  "proName": "FX_IDC:EURUSD",
                  "title": "EUR to USD"
                },
                {
                  "proName": "BITSTAMP:BTCUSD",
                  "title": "Bitcoin"
                },
                {
                  "proName": "BITSTAMP:ETHUSD",
                  "title": "Ethereum"
                },
                {
                  "proName": "TVC:GOLD",
                  "title": "Gold"
                },
                {
                  "proName": "NASDAQ:NVDA",
                  "title": "NVDA"
                },
                {
                  "proName": "NASDAQ:AAPL",
                  "title": "Apple"
                },
                {
                  "proName": "CRYPTOCAP:BTC.D",
                  "title": "BTC Dominance"
                },
                {
                  "proName": "NASDAQ:QQQ",
                  "title": "QQQ"
                },
                {
                  "proName": "NASDAQ:AMZN",
                  "title": "Amazon"
                },
                {
                  "proName": "NASDAQ:AMD",
                  "title": "AMD"
                },
                {
                  "proName": "NASDAQ:MSTR",
                  "title": "Microstrategy/Strategy"
                },
                {
                  "proName": "NASDAQ:COIN",
                  "title": "Coinbase"
                },
                {
                  "proName": "NASDAQ:ASML",
                  "title": "ASML"
                },
                {
                  "proName": "BCBA:TSMC",
                  "title": "TSMC"
                },
                {
                  "proName": "AMEX:MSTY",
                  "title": "MSTY"
                },
                {
                  "proName": "NASDAQ:META",
                  "title": "META"
                },
                {
                  "proName": "NASDAQ:GOOGL",
                  "title": "Alphabet/Google"
                },
                {
                  "proName": "NASDAQ:MSTR",
                  "title": "MSTR"
                },
                {
                  "proName": "AMEX:WNTR",
                  "title": "WNTR"
                }
              ],
              "colorTheme": "dark",
              "locale": "en",
              "largeChartUrl": "",
              "isTransparent": true,
              "showSymbolLogo": false,
              "displayMode": "adaptive"
            }
              </script>
            </div>
            <!-- TradingView Widget END -->

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div>
                    <h1>Main Dashboard</h1>
                    <h2>Positions *Live/Historical</h2>
                </div>
                <div class="date">
                    <input type="date" aria-label="Select date for historical data" id="date-picker">
                </div>
            </div>

 <!--((((((((((((((End of Date))))))))))))))-->

            <div class="insights" role="region" aria-label="Portfolio metrics">
                <div class="sales metric-card-clickable" role="article" aria-labelledby="total-position-label" onclick="openMetricsModal('portfolio')" style="cursor: pointer;" title="Click for detailed breakdown">
                    <span class="material-icons-sharp" aria-hidden="true">attach_money</span>
                    <div class="middle">
                        <div class="left">
                            <h3 id="total-position-label">Total Position</h3>
                            <h3>USD</h3>
                            <h1>$0.00</h1>
                        </div>

                        
                        <div class="progress">
                            <svg>
                                <circle cx=38 cy=36 r=36 ></circle>
                            </svg>
                            <div class="number">
                                <p>+0.0%</p>
                            </div>
                        </div>
                    </div>
                    <small class="text-muted">Portfolio Growth</small>
                </div>
                <!--(((((((((((((End of Sales)))))))))))))-->

                <div class="expenses metric-card-clickable" role="article" aria-labelledby="pnl-label" onclick="openMetricsModal('pnl')" style="cursor: pointer;" title="Click for detailed breakdown">
                    <span class="material-icons-sharp" aria-hidden="true">trending_up</span>
                    <div class="middle">
                        <div class="left">
                            <h3 id="pnl-label">Total P&L</h3>
                            <h3>USD</h3>
                            <h1>$0.00</h1>
                        </div>
                        <div class="progress">
                            <svg>
                                <circle cx=38 cy=36 r=36 ></circle>
                            </svg>
                            <div class="number">
                                <p>+0.0%</p>
                            </div>
                        </div>
                    </div>
                    <small class="text-muted">Unrealized Gains</small>
                </div>
                <!--(((((((((((((End of Expenses)))))))))))))-->

                <div class="income metric-card-clickable" role="article" aria-labelledby="win-rate-label" onclick="openMetricsModal('winrate')" style="cursor: pointer;" title="Click for detailed breakdown">
                    
                    <span class="material-icons-sharp" aria-hidden="true" style="background: var(--color-warning);">assessment</span>

                    <div class="middle">
                        <div class="left">
                            <h3 id="win-rate-label">Win Rate</h3>
                            <h1 id="winRateValue">0%</h1>
                        </div>
                        <div class="progress" style="position: relative;">
                            <!-- Radial Gauge Chart -->
                            <div id="winRateGauge" style="background: transparent !important;"></div>
                        </div>
                    </div>
                    <small class="text-muted">Success Rate</small>
                </div>
                <!--(((((((((((((End of Income)))))))))))))-->
            </div>
            <!--(((((((((((((End of Insights)))))))))))))-->
                <div class="recent-orders" role="region" aria-labelledby="orders-heading">
                    <h2 id="orders-heading">Indices & Commodities</h2>
                    <table role="table" aria-label="Trading positions and orders">
                        <thead>
                            <tr>
                                <th>Asset</th>
                                <th>Price/Qty</th>
                                <th>P&L</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- Orders will be populated by JavaScript -->
                        </tbody>
                    </table>
                    <a href="#">Show All</a>
                </div>
        </main>
        <!--(((((((((((((End of MAIN)))))))))))))-->
        <div class="right">
            <div class="top">
                <button id="menu-btn" aria-label="Open menu" aria-expanded="false">
                    <span class="material-icons-sharp" aria-hidden="true">menu</span>
                </button>    
                    <div class="theme-toggler" role="group" aria-label="Theme selection">
                        <span class="material-icons-sharp active" role="button" aria-label="Light mode" aria-pressed="true" tabindex="0">light_mode</span>
                        <span class="material-icons-sharp" role="button" aria-label="Dark mode" aria-pressed="false" tabindex="0">dark_mode</span>
                    </div>
                    
                    <!-- API Status Indicator -->
                    <div id="apiStatus" style="display: none; padding: 0.5rem 1rem; background: #10b981; color: white; border-radius: 0.5rem; font-size: 0.85rem; font-weight: 600; margin-left: 1rem;">
                        <span class="material-icons-sharp" style="font-size: 1rem; vertical-align: middle;">cloud_done</span>
                        Live Data
                    </div>
                    
                    <div class="profile">
                        <div class="info">
                            <p> Key: <b>Gavin</b></p>
                            <small class="text-muted">Admin</small>
                        </div>
                        <div class="profile-pic">
                            <img src="assets/profile-pic-1.png" alt="Gavin's profile picture" height="50px" width="50px">
                        </div>
                    </div>
                
            </div>
        
            <!--(((((((((((((End of Top)))))))))))))-->

            <div class="recent-updates" role="region" aria-labelledby="updates-heading">
                <h2 id="updates-heading">Recent Updates</h2>

                <div class="updates" id="recentUpdates" aria-live="polite" aria-atomic="false">
                    <div class="update" role="article">
                        <div class="profile-photo update-icon success">
                            <span class="material-icons-sharp" aria-hidden="true">savings</span>
                        </div>
                        <div class="message">
                            <p><b>Gold</b> Loading...</p>
                            <small class="text-muted">Loading...</small>
                        </div>
                    </div>
                    
                    <div class="update" role="article">
                        <div class="profile-photo update-icon primary">
                            <span class="material-icons-sharp" aria-hidden="true">show_chart</span>
                        </div>
                        <div class="message">
                            <p><b>S&P 500</b> Loading...</p>
                            <small class="text-muted">Loading...</small>
                        </div>
                    </div>
                    
                    <div class="update" role="article">
                        <div class="profile-photo update-icon warning">
                            <span class="material-icons-sharp" aria-hidden="true">currency_bitcoin</span>
                        </div>
                        <div class="message">
                            <p><b>Bitcoin</b> Loading...</p>
                            <small class="text-muted">Loading...</small>
                        </div>
                    </div>
                </div>

            </div>

            <!--(((((((((((((End of Recent Updates)))))))))))))-->

            <div class="sales-analytics" role="region" aria-labelledby="analytics-heading">
                <h2 id="analytics-heading">Market Analytics</h2>

                <div class="item customers" id="bestPerformer" role="article" aria-labelledby="top-performer-label">
                    <div class="icon">
                        <span class="material-icons-sharp" aria-hidden="true">trending_up</span>
                    </div>
                    <div class="right">
                        <div class="info">
                            <h3 id="top-performer-label">TOP PERFORMER</h3>
                            <small class="text-muted">--</small>
                        </div>
                        <h5 class="success">+0.00%</h5>
                        <h3>$--</h3>
                    </div>   
                </div>

                <div class="item offline" id="worstPerformer" role="article" aria-labelledby="needs-attention-label">
                    <div class="icon">
                        <span class="material-icons-sharp" aria-hidden="true">trending_down</span>
                    </div>
                    <div class="right">
                        <div class="info">
                            <h3 id="needs-attention-label">NEEDS ATTENTION</h3>
                            <small class="text-muted">--</small>
                        </div>
                        <h5 class="danger">+0.00%</h5>
                        <h3>$--</h3>
                    </div>
                </div>   

                <div class="item add-product" role="button" tabindex="0" aria-label="Add new trading position">
                    <div>
                        <span class="material-icons-sharp" aria-hidden="true">add</span>
                        <h3>Add Position</h3>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Position Details Modal -->
    <div id="positionModal" class="modal" role="dialog" aria-labelledby="modalTitle" aria-modal="true" style="display: none;">
        <div class="modal-overlay" aria-hidden="true"></div>
        <div class="modal-container">
            <div class="modal-header">
                <h2 id="modalTitle">Position Details</h2>
                <button class="modal-close" aria-label="Close modal">
                    <span class="material-icons-sharp">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-asset-header">
                    <div class="asset-icon">
                        <span class="material-icons-sharp">trending_up</span>
                    </div>
                    <div class="asset-info">
                        <h3 id="modalAssetName">--</h3>
                        <p class="text-muted" id="modalAssetType">--</p>
                    </div>
                    <div class="asset-status">
                        <span class="status-badge" id="modalStatus">--</span>
                    </div>
                </div>

                <div class="modal-grid">
                    <div class="modal-card">
                        <div class="card-icon success">
                            <span class="material-icons-sharp">attach_money</span>
                        </div>
                        <div class="card-content">
                            <p class="text-muted">Current Price</p>
                            <h3 id="modalCurrentPrice">--</h3>
                            <small id="modalPriceChange" class="success">--</small>
                        </div>
                    </div>

                    <div class="modal-card">
                        <div class="card-icon primary">
                            <span class="material-icons-sharp">account_balance_wallet</span>
                        </div>
                        <div class="card-content">
                            <p class="text-muted">Entry Price</p>
                            <h3 id="modalEntryPrice">--</h3>
                            <small id="modalEntryDate" class="text-muted">--</small>
                        </div>
                    </div>

                    <div class="modal-card">
                        <div class="card-icon warning">
                            <span class="material-icons-sharp">assessment</span>
                        </div>
                        <div class="card-content">
                            <p class="text-muted">Quantity</p>
                            <h3 id="modalQuantity">--</h3>
                            <small id="modalPositionSize" class="text-muted">--</small>
                        </div>
                    </div>

                    <div class="modal-card highlight">
                        <div class="card-icon">
                            <span class="material-icons-sharp">analytics</span>
                        </div>
                        <div class="card-content">
                            <p class="text-muted">Profit & Loss</p>
                            <h3 id="modalPnL">--</h3>
                            <small id="modalPnLPercent" class="success">--</small>
                        </div>
                    </div>
                </div>

                <div class="modal-details">
                    <div class="detail-row">
                        <span class="detail-label">Position Type</span>
                        <span class="detail-value" id="modalPositionType">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Stop Loss</span>
                        <span class="detail-value" id="modalStopLoss">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Take Profit</span>
                        <span class="detail-value" id="modalTakeProfit">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Risk/Reward Ratio</span>
                        <span class="detail-value" id="modalRiskReward">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Days Held</span>
                        <span class="detail-value" id="modalDaysHeld">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Trade ID</span>
                        <span class="detail-value text-muted" id="modalTradeId">--</span>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn btn-outline" id="modalEditBtn">
                        <span class="material-icons-sharp">edit</span>
                        Edit Position
                    </button>
                    <button class="btn btn-danger" id="modalClosePositionBtn">
                        <span class="material-icons-sharp">close</span>
                        Close Position
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Tooltip -->
    <div id="chartTooltip" class="chart-tooltip" style="display: none;">
        <div class="chart-tooltip-header">
            <span id="chartTooltipAsset" class="chart-tooltip-asset">Asset</span>
            <span id="chartTooltipPrice" class="chart-tooltip-price">$0.00</span>
        </div>
        <canvas id="chartTooltipCanvas" width="280" height="140"></canvas>
        <div class="chart-tooltip-stats">
            <div class="stat">
                <span class="label">Change</span>
                <span id="chartTooltipChange" class="value">+0.00%</span>
            </div>
            <div class="stat">
                <span class="label">Volume</span>
                <span id="chartTooltipVolume" class="value">0</span>
            </div>
        </div>
    </div>

    <!-- Metrics Modal -->
    <div id="metricsModal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-container" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="metricsModalTitle">Portfolio Metrics</h2>
                <button class="modal-close" onclick="closeMetricsModal()">
                    <span class="material-icons-sharp">close</span>
                </button>
            </div>
            <div class="modal-body" id="metricsModalBody">
                <!-- Content will be dynamically loaded -->
            </div>
        </div>
    </div>

    <!-- TradingView Chart Modal (Full Page) -->
    <div id="tradingViewModal" class="trading-view-modal" style="display: none;">
        <div class="trading-view-modal-overlay"></div>
        <div class="trading-view-modal-container">
            <div class="trading-view-modal-header">
                <div class="trading-view-modal-title-section">
                    <h2 id="tradingViewModalTitle">Live Chart</h2>
                    <span class="live-indicator"><span class="live-dot"></span>Live Data</span>
                </div>
                <button class="modal-close" onclick="closeTradingViewModal()">
                    <span class="material-icons-sharp">close</span>
                </button>
            </div>
            <div class="trading-view-modal-body">
                <div class="trading-view-chart-info">
                    <div class="chart-info-item">
                        <span class="chart-info-label">Current Price</span>
                        <span class="chart-info-value" id="tvCurrentPrice">Loading...</span>
                    </div>
                    <div class="chart-info-item">
                        <span class="chart-info-label">24h Change</span>
                        <span class="chart-info-value" id="tv24hChange">--</span>
                    </div>
                    <div class="chart-info-item">
                        <span class="chart-info-label">24h High</span>
                        <span class="chart-info-value" id="tv24hHigh">--</span>
                    </div>
                    <div class="chart-info-item">
                        <span class="chart-info-label">24h Low</span>
                        <span class="chart-info-value" id="tv24hLow">--</span>
                    </div>
                    <div class="chart-info-item">
                        <span class="chart-info-label">Market Cap</span>
                        <span class="chart-info-value" id="tvMarketCap">--</span>
                    </div>
                    <div class="chart-info-item">
                        <span class="chart-info-label">24h Volume</span>
                        <span class="chart-info-value" id="tv24hVolume">--</span>
                    </div>
                    <div class="chart-info-item">
                        <span class="chart-info-label">Circulating Supply</span>
                        <span class="chart-info-value" id="tvCircSupply">--</span>
                    </div>
                    <div class="chart-info-item">
                        <span class="chart-info-label">All Time High</span>
                        <span class="chart-info-value" id="tvATH">--</span>
                    </div>
                </div>
                <div id="tradingViewChartContainer" style="width: 100%; height: calc(100vh - 400px); min-height: 400px;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    <script src="scripts/error-handler.js"></script>
    <script src="scripts/security-utils.js"></script>
    <script src="scripts/performance-utils.js"></script>
    <script src="scripts/config.js"></script>
    <script src="scripts/config.local.js"></script>
    <script src="scripts/data-service.js"></script>
    <script src="scripts/notification-service.js"></script>
    <script src="scripts/utils.js"></script>
    <script src="scripts/data-utils.js"></script>
    <script src="scripts/countup-enhanced.js"></script>
    <script src="scripts/orders.js"></script>
    <script src="scripts/position-modal.js"></script>
    <script src="scripts/chart-tooltip.js"></script>
    <script src="scripts/main.js"></script>
    
    <!-- TradingView Chart Modal Script -->
    <script>
    let tvModalChart = null;
    let tvModalSeries = null;
    let tvModalHoverTimeout = null;
    let tvCurrentAsset = null;

    // Asset symbol mapping for different data sources
    const assetSymbolMap = {
        // Cryptocurrencies
        'Bitcoin': { type: 'crypto', symbol: 'BTC', coinGeckoId: 'bitcoin', twelveDataSymbol: 'BTC/USD' },
        'Ethereum': { type: 'crypto', symbol: 'ETH', coinGeckoId: 'ethereum', twelveDataSymbol: 'ETH/USD' },
        'Solana': { type: 'crypto', symbol: 'SOL', coinGeckoId: 'solana', twelveDataSymbol: 'SOL/USD' },
        'Cardano': { type: 'crypto', symbol: 'ADA', coinGeckoId: 'cardano', twelveDataSymbol: 'ADA/USD' },
        'XRP': { type: 'crypto', symbol: 'XRP', coinGeckoId: 'ripple', twelveDataSymbol: 'XRP/USD' },
        'Dogecoin': { type: 'crypto', symbol: 'DOGE', coinGeckoId: 'dogecoin', twelveDataSymbol: 'DOGE/USD' },
        'BNB': { type: 'crypto', symbol: 'BNB', coinGeckoId: 'binancecoin', twelveDataSymbol: 'BNB/USD' },
        
        // Indices & ETFs
        'S&P 500': { type: 'index', symbol: 'SPY', coinGeckoId: null, twelveDataSymbol: 'SPY' },
        'S&P': { type: 'index', symbol: 'SPY', coinGeckoId: null, twelveDataSymbol: 'SPY' }, // Alias
        'SPY': { type: 'index', symbol: 'SPY', coinGeckoId: null, twelveDataSymbol: 'SPY' }, // Alias
        'NASDAQ': { type: 'index', symbol: 'QQQ', coinGeckoId: null, twelveDataSymbol: 'QQQ' },
        'QQQ': { type: 'index', symbol: 'QQQ', coinGeckoId: null, twelveDataSymbol: 'QQQ' },
        'FTSE': { type: 'index', symbol: 'ISF.LON', coinGeckoId: null, twelveDataSymbol: 'ISF.LON' },
        
        // Commodities
        'Gold': { type: 'commodity', symbol: 'XAU/USD', coinGeckoId: null, twelveDataSymbol: 'XAUUSD' },
        'Silver': { type: 'commodity', symbol: 'XAG/USD', coinGeckoId: null, twelveDataSymbol: 'XAGUSD' },
        'Oil': { type: 'commodity', symbol: 'CL', coinGeckoId: null, twelveDataSymbol: 'USOIL' },
        'Crude Oil': { type: 'commodity', symbol: 'CL', coinGeckoId: null, twelveDataSymbol: 'USOIL' },
        'Crude': { type: 'commodity', symbol: 'CL', coinGeckoId: null, twelveDataSymbol: 'USOIL' }, // Alias
        'Natural Gas': { type: 'commodity', symbol: 'NG', coinGeckoId: null, twelveDataSymbol: 'NATGAS' },
        'Natural': { type: 'commodity', symbol: 'NG', coinGeckoId: null, twelveDataSymbol: 'NATGAS' }, // Alias
        
        // Forex
        'EUR/USD': { type: 'forex', symbol: 'EUR/USD', coinGeckoId: null, twelveDataSymbol: 'EUR/USD' },
        'GBP/USD': { type: 'forex', symbol: 'GBP/USD', coinGeckoId: null, twelveDataSymbol: 'GBP/USD' },
        'USD/JPY': { type: 'forex', symbol: 'USD/JPY', coinGeckoId: null, twelveDataSymbol: 'USD/JPY' }
    };

    // Generate historical chart data from current price (with live API support)
    async function generateChartData(currentPrice, days = 30) {
        // Try to fetch real historical data for crypto assets
        const useMockData = window.AppConfig?.useMockData ?? false;
        if (!useMockData && window.DataService && window.DataService.fetchCryptoHistoricalData && tvCurrentAsset) {
            const cryptoMap = {
                'Bitcoin': 'bitcoin',
                'Ethereum': 'ethereum',
                'Solana': 'solana',
                'Cardano': 'cardano',
                'XRP': 'ripple'
            };
            
            if (cryptoMap[tvCurrentAsset]) {
                try {
                    console.log('[TradingView Modal] Fetching live historical data for', tvCurrentAsset);
                    const historicalData = await window.DataService.fetchCryptoHistoricalData(cryptoMap[tvCurrentAsset], days);
                    if (historicalData && historicalData.length > 0) {
                        console.log('[TradingView Modal] ✅ Using', historicalData.length, 'days of live data');
                        return historicalData.map(d => ({
                            time: Math.floor(new Date(d.date).getTime() / 1000),
                            value: d.price
                        }));
                    }
                } catch (error) {
                    console.warn('[TradingView Modal] Failed to fetch live data, using fallback');
                }
            }
        }
        
        // Fallback to generated data
        console.log('[TradingView Modal] Using generated chart data');
        const data = [];
        const now = Math.floor(Date.now() / 1000);
        const dayInSeconds = 24 * 60 * 60;
        let price = currentPrice * 0.92; // Start 8% lower for upward trend
        const volatility = currentPrice * 0.015; // 1.5% volatility
        const trend = (currentPrice - price) / days;
        
        for (let i = days; i >= 0; i--) {
            const time = now - (i * dayInSeconds);
            const randomChange = (Math.random() - 0.5) * volatility;
            price += trend + randomChange;
            
            data.push({
                time: time,
                value: parseFloat(price.toFixed(2))
            });
        }
        
        // Ensure last point is current price
        data[data.length - 1].value = currentPrice;
        return data;
    }

    // Fetch stock/commodity/index/forex data
    async function fetchStockCommodityData(assetName) {
        try {
            const assetInfo = assetSymbolMap[assetName];
            if (!assetInfo) {
                console.warn('[TradingView Modal] No asset info for:', assetName);
                return null;
            }

            // Try Twelve Data API first
            if (typeof DataService !== 'undefined' && DataService.fetchAssetQuote) {
                try {
                    const quoteData = await DataService.fetchAssetQuote(assetInfo.twelveDataSymbol || assetInfo.symbol);
                    if (quoteData && (quoteData.close || quoteData.price)) {
                        console.log('[TradingView Modal] Stock/Commodity API data received:', quoteData);
                        return {
                            price: parseFloat(quoteData.close || quoteData.price),
                            change: parseFloat(quoteData.percent_change || quoteData.change_percent || 0),
                            high: parseFloat(quoteData.high || 0),
                            low: parseFloat(quoteData.low || 0),
                            volume: parseFloat(quoteData.volume || 0),
                            symbol: quoteData.symbol || assetInfo.symbol
                        };
                    }
                } catch (apiError) {
                    console.warn('[TradingView Modal] API failed, using fallback data:', apiError.message);
                }
            }

            // Fallback to mock data based on asset type
            const mockData = {
                // Indices
                'SPY': { price: 450.25, change: 0.85, high: 452.10, low: 448.30, volume: 75000000 },
                'QQQ': { price: 364.42, change: 1.20, high: 366.80, low: 362.50, volume: 45000000 },
                // Commodities
                'XAUUSD': { price: 1985.50, change: -0.35, high: 1992.00, low: 1978.20, volume: 125000 },
                'XAGUSD': { price: 23.45, change: -0.80, high: 23.75, low: 23.10, volume: 85000 },
                'USOIL': { price: 82.35, change: 1.45, high: 83.20, low: 81.50, volume: 250000 },
                'NATGAS': { price: 2.87, change: -2.35, high: 2.95, low: 2.82, volume: 180000 },
                // Forex
                'EUR/USD': { price: 1.0725, change: 0.15, high: 1.0745, low: 1.0710, volume: 0 },
                'GBP/USD': { price: 1.2150, change: -0.25, high: 1.2180, low: 1.2130, volume: 0 }
            };

            const mockKey = assetInfo.twelveDataSymbol || assetInfo.symbol;
            if (mockData[mockKey]) {
                console.log('[TradingView Modal] Using mock data for:', mockKey);
                return { ...mockData[mockKey], symbol: assetInfo.symbol };
            }

            return null;
        } catch (error) {
            console.error('[TradingView Modal] Error fetching stock/commodity data:', error);
            return null;
        }
    }

    // Fetch live crypto data with comprehensive details
    async function fetchCryptoDataForChart(assetName) {
        try {
            const assetInfo = assetSymbolMap[assetName];
            if (!assetInfo || !assetInfo.coinGeckoId) {
                console.warn('[TradingView Modal] No CoinGecko ID for:', assetName);
                return null;
            }

            // Fetch detailed crypto data from CoinGecko
            const coinId = assetInfo.coinGeckoId;
            const apiUrl = `https://api.coingecko.com/api/v3/coins/${coinId}?localization=false&tickers=false&community_data=false&developer_data=false`;
            
            try {
                const response = await fetch(apiUrl);
                if (response.ok) {
                    const data = await response.json();
                    console.log('[TradingView Modal] Detailed crypto data received:', data);
                    
                    // Extract all relevant data
                    return {
                        usd: data.market_data?.current_price?.usd,
                        usd_24h_change: data.market_data?.price_change_percentage_24h,
                        high_24h: data.market_data?.high_24h?.usd,
                        low_24h: data.market_data?.low_24h?.usd,
                        market_cap: data.market_data?.market_cap?.usd,
                        total_volume: data.market_data?.total_volume?.usd,
                        circulating_supply: data.market_data?.circulating_supply,
                        ath: data.market_data?.ath?.usd,
                        ath_date: data.market_data?.ath_date?.usd,
                        ath_change_percentage: data.market_data?.ath_change_percentage?.usd,
                        symbol: data.symbol?.toUpperCase()
                    };
                }
            } catch (directError) {
                console.warn('[TradingView Modal] Direct API call failed, trying fallback...');
            }
            
            // Fallback to simple price endpoint
            if (typeof DataService !== 'undefined' && DataService.fetchCryptoPrices) {
                const data = await DataService.fetchCryptoPrices([coinId]);
                if (data && data[coinId]) {
                    return data[coinId];
                }
            }
            return null;
        } catch (error) {
            console.error('[TradingView Modal] Error fetching crypto data:', error);
            return null;
        }
    }

    // Extract price from update message
    function extractPriceFromMessage(message) {
        // Look for patterns like "$1,234.56" or "trading at $1,234"
        const priceMatch = message.match(/\$([\d,]+\.?\d*)/); 
        if (priceMatch) {
            return parseFloat(priceMatch[1].replace(/,/g, ''));
        }
        return null;
    }

    // Open TradingView modal with asset data
    async function openTradingViewModal(assetName, messageText) {
        console.log('[TradingView Modal] Opening for:', assetName);
        console.log('[TradingView Modal] Message text:', messageText);
        
        tvCurrentAsset = assetName;
        const modal = document.getElementById('tradingViewModal');
        const titleEl = document.getElementById('tradingViewModalTitle');
        const currentPriceEl = document.getElementById('tvCurrentPrice');
        const changeEl = document.getElementById('tv24hChange');
        const highEl = document.getElementById('tv24hHigh');
        const lowEl = document.getElementById('tv24hLow');
        const marketCapEl = document.getElementById('tvMarketCap');
        const volumeEl = document.getElementById('tv24hVolume');
        const supplyEl = document.getElementById('tvCircSupply');
        const athEl = document.getElementById('tvATH');
        
        console.log('[TradingView Modal] Modal element found:', !!modal);
        console.log('[TradingView Modal] Elements check:', {
            title: !!titleEl,
            price: !!currentPriceEl,
            change: !!changeEl,
            high: !!highEl,
            low: !!lowEl,
            marketCap: !!marketCapEl,
            volume: !!volumeEl,
            supply: !!supplyEl,
            ath: !!athEl
        });
        
        if (!modal) {
            console.error('[TradingView Modal] Modal element not found!');
            return;
        }
        
        // Show modal
        modal.style.display = 'block';
        setTimeout(() => modal.classList.add('active'), 10);
        document.body.style.overflow = 'hidden';
        
        // Set title
        if (titleEl) titleEl.textContent = `${assetName} - Live Chart`;
        
        // Reset all fields to loading state
        if (currentPriceEl) currentPriceEl.textContent = 'Loading...';
        if (changeEl) changeEl.textContent = 'Loading...';
        if (highEl) highEl.textContent = 'Loading...';
        if (lowEl) lowEl.textContent = 'Loading...';
        if (marketCapEl) marketCapEl.textContent = 'Loading...';
        if (volumeEl) volumeEl.textContent = 'Loading...';
        if (supplyEl) supplyEl.textContent = 'Loading...';
        if (athEl) athEl.textContent = 'Loading...';
        
        // Extract price from message or fetch live data
        let currentPrice = extractPriceFromMessage(messageText);
        let change24h = null;
        let high24h = null;
        let low24h = null;
        let marketCap = null;
        let volume24h = null;
        let circulatingSupply = null;
        let ath = null;
        let athChangePercentage = null;
        let symbol = null;
        
        // Try to get live data
        const assetInfo = assetSymbolMap[assetName];
        console.log('[TradingView Modal] Asset info:', assetInfo);
        
        // Adjust field labels and visibility based on asset type
        const marketCapItem = document.querySelector('#tvMarketCap').closest('.chart-info-item');
        const supplyItem = document.querySelector('#tvCircSupply').closest('.chart-info-item');
        const athItem = document.querySelector('#tvATH').closest('.chart-info-item');
        const changeLabel = document.querySelector('#tv24hChange').previousElementSibling;
        const highLabel = document.querySelector('#tv24hHigh').previousElementSibling;
        const lowLabel = document.querySelector('#tv24hLow').previousElementSibling;
        
        if (assetInfo && (assetInfo.type === 'commodity' || assetInfo.type === 'index' || assetInfo.type === 'forex' || assetInfo.type === 'stock')) {
            // For non-crypto assets, hide market cap, supply, and ATH
            if (marketCapItem) marketCapItem.style.display = 'none';
            if (supplyItem) supplyItem.style.display = 'none';
            if (athItem) athItem.style.display = 'none';
            
            // Change labels from "24h" to "Daily" for stocks/commodities
            if (changeLabel) changeLabel.textContent = 'Daily Change';
            if (highLabel) highLabel.textContent = 'Daily High';
            if (lowLabel) lowLabel.textContent = 'Daily Low';
        } else {
            // For crypto, show all fields with "24h" labels
            if (marketCapItem) marketCapItem.style.display = '';
            if (supplyItem) supplyItem.style.display = '';
            if (athItem) athItem.style.display = '';
            
            if (changeLabel) changeLabel.textContent = '24h Change';
            if (highLabel) highLabel.textContent = '24h High';
            if (lowLabel) lowLabel.textContent = '24h Low';
        }
        
        if (assetInfo) {
            if (assetInfo.type === 'crypto') {
                // Fetch cryptocurrency data
                console.log('[TradingView Modal] Fetching crypto data...');
                const liveData = await fetchCryptoDataForChart(assetName);
                console.log('[TradingView Modal] Crypto data received:', liveData);
                
                if (liveData) {
                    currentPrice = liveData.usd;
                    change24h = liveData.usd_24h_change;
                    high24h = liveData.high_24h;
                    low24h = liveData.low_24h;
                    marketCap = liveData.market_cap;
                    volume24h = liveData.total_volume;
                    circulatingSupply = liveData.circulating_supply;
                    ath = liveData.ath;
                    athChangePercentage = liveData.ath_change_percentage;
                    symbol = liveData.symbol;
                    
                    console.log('[TradingView Modal] Data parsed:', {
                        price: currentPrice,
                        change: change24h,
                        marketCap: marketCap,
                        volume: volume24h
                    });
                }
            } else if (assetInfo.type === 'commodity' || assetInfo.type === 'index' || assetInfo.type === 'forex' || assetInfo.type === 'stock') {
                // Fetch stock/commodity/index/forex data
                console.log('[TradingView Modal] Fetching stock/commodity/index/forex data...');
                const stockData = await fetchStockCommodityData(assetName);
                console.log('[TradingView Modal] Stock/Commodity data received:', stockData);
                
                if (stockData) {
                    currentPrice = stockData.price;
                    change24h = stockData.change;
                    high24h = stockData.high;
                    low24h = stockData.low;
                    volume24h = stockData.volume;
                    symbol = stockData.symbol || assetInfo.symbol;
                    
                    console.log('[TradingView Modal] Data parsed:', {
                        price: currentPrice,
                        change: change24h,
                        high: high24h,
                        low: low24h,
                        volume: volume24h
                    });
                }
            }
        } else {
            console.warn('[TradingView Modal] Asset not found in map:', assetName);
        }
        
        // Helper function to format large numbers
        function formatLargeNumber(num) {
            if (!num) return '--';
            if (num >= 1e12) return `$${(num / 1e12).toFixed(2)}T`;
            if (num >= 1e9) return `$${(num / 1e9).toFixed(2)}B`;
            if (num >= 1e6) return `$${(num / 1e6).toFixed(2)}M`;
            if (num >= 1e3) return `$${(num / 1e3).toFixed(2)}K`;
            return `$${num.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
        }
        
        // Update current price
        if (currentPrice && currentPriceEl) {
            const priceText = `$${currentPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            currentPriceEl.textContent = priceText;
            console.log('[TradingView Modal] Updated current price to:', priceText);
        } else if (currentPriceEl) {
            currentPriceEl.textContent = '--';
            console.log('[TradingView Modal] No current price, set to --');
        } else {
            console.warn('[TradingView Modal] currentPriceEl not found!');
        }
        
        // Update 24h change
        if (change24h !== null && changeEl) {
            const changeClass = change24h >= 0 ? 'success' : 'danger';
            const changeSign = change24h >= 0 ? '+' : '';
            const changeText = `${changeSign}${change24h.toFixed(2)}%`;
            changeEl.textContent = changeText;
            changeEl.className = `chart-info-value ${changeClass}`;
            console.log('[TradingView Modal] Updated 24h change to:', changeText, 'class:', changeClass);
        } else if (changeEl) {
            changeEl.textContent = '--';
            changeEl.className = 'chart-info-value';
            console.log('[TradingView Modal] No change data, set to --');
        } else {
            console.warn('[TradingView Modal] changeEl not found!');
        }
        
        // Update 24h high
        if (high24h && highEl) {
            highEl.textContent = `$${high24h.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
        } else if (highEl) {
            highEl.textContent = '--';
        }
        
        // Update 24h low
        if (low24h && lowEl) {
            lowEl.textContent = `$${low24h.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
        } else if (lowEl) {
            lowEl.textContent = '--';
        }
        
        // Update market cap
        if (marketCap && marketCapEl) {
            marketCapEl.textContent = formatLargeNumber(marketCap);
        } else if (marketCapEl) {
            marketCapEl.textContent = '--';
        }
        
        // Update 24h volume
        if (volume24h && volumeEl) {
            volumeEl.textContent = formatLargeNumber(volume24h);
        } else if (volumeEl) {
            volumeEl.textContent = '--';
        }
        
        // Update circulating supply
        if (circulatingSupply && supplyEl && symbol) {
            const formattedSupply = circulatingSupply >= 1e9 ? 
                `${(circulatingSupply / 1e9).toFixed(2)}B ${symbol}` :
                circulatingSupply >= 1e6 ?
                `${(circulatingSupply / 1e6).toFixed(2)}M ${symbol}` :
                `${circulatingSupply.toLocaleString('en-US', {maximumFractionDigits: 0})} ${symbol}`;
            supplyEl.textContent = formattedSupply;
        } else if (supplyEl) {
            supplyEl.textContent = '--';
        }
        
        // Update ATH
        if (ath && athEl) {
            let athText = `$${ath.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            if (athChangePercentage !== null) {
                const athClass = athChangePercentage >= 0 ? 'success' : 'danger';
                athText += ` <span class="${athClass}" style="font-size: 0.85em;">(${athChangePercentage.toFixed(1)}%)</span>`;
            }
            athEl.innerHTML = athText;
        } else if (athEl) {
            athEl.textContent = '--';
        }
        
        // Initialize chart
        initTradingViewChart(assetName, currentPrice || 1000);
    }

    // Initialize the TradingView chart (async to support live data)
    async function initTradingViewChart(assetName, currentPrice) {
        const container = document.getElementById('tradingViewChartContainer');
        if (!container) return;
        
        // Clear existing chart
        if (tvModalChart) {
            try {
                tvModalChart.remove();
            } catch (e) {
                console.warn('[TradingView Modal] Error removing chart:', e);
            }
            tvModalChart = null;
            tvModalSeries = null;
        }
        
        // Check if LightweightCharts is available
        if (typeof LightweightCharts === 'undefined') {
            console.error('[TradingView Modal] LightweightCharts library not loaded');
            container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--color-info-dark);"><p>Chart library not loaded. Please refresh the page.</p></div>';
            return;
        }
        
        try {
            // Create chart
            tvModalChart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: container.clientHeight,
                layout: {
                    background: { color: 'transparent' },
                    textColor: getComputedStyle(document.documentElement).getPropertyValue('--color-dark').trim() || '#111827',
                },
                grid: {
                    vertLines: { color: 'rgba(107, 114, 128, 0.1)' },
                    horzLines: { color: 'rgba(107, 114, 128, 0.1)' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: 'rgba(107, 114, 128, 0.2)',
                },
                timeScale: {
                    borderColor: 'rgba(107, 114, 128, 0.2)',
                    timeVisible: true,
                    secondsVisible: false,
                },
            });
            
            // Determine chart style based on asset
            const assetInfo = assetSymbolMap[assetName];
            if (assetInfo && assetInfo.type === 'crypto') {
                // Use area chart for crypto
                tvModalSeries = tvModalChart.addAreaSeries({
                    topColor: 'rgba(239, 142, 66, 0.4)',
                    bottomColor: 'rgba(239, 142, 66, 0.0)',
                    lineColor: '#f59e0b',
                    lineWidth: 2,
                });
            } else {
                // Use candlestick or line chart for stocks/commodities
                tvModalSeries = tvModalChart.addLineSeries({
                    color: '#2d6cdf',
                    lineWidth: 2,
                });
            }
            
            // Generate and set data (await for live data)
            const chartData = await generateChartData(currentPrice, 30);
            tvModalSeries.setData(chartData);
            
            console.log('[TradingView Modal] Chart initialized with', chartData.length, 'points');
        } catch (error) {
            console.error('[TradingView Modal] Error creating chart:', error);
            container.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--color-danger);"><p>Error loading chart. Please try again.</p></div>`;
        }
    }

    // Close TradingView modal
    function closeTradingViewModal() {
        const modal = document.getElementById('tradingViewModal');
        if (!modal) return;
        
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            
            // Clean up chart
            if (tvModalChart) {
                try {
                    tvModalChart.remove();
                } catch (e) {
                    console.warn('[TradingView Modal] Error removing chart on close:', e);
                }
                tvModalChart = null;
                tvModalSeries = null;
            }
        }, 300);
    }

    // Add hover event listeners to recent updates
    function initRecentUpdatesHoverListeners() {
        const updates = document.querySelectorAll('.recent-updates .update');
        
        updates.forEach(update => {
            const messageEl = update.querySelector('.message p');
            if (!messageEl) return;
            
            // Add hover cursor
            update.style.cursor = 'pointer';
            update.style.transition = 'transform 0.2s ease, box-shadow 0.2s ease';
            
            // Mouse enter - start timer
            update.addEventListener('mouseenter', function() {
                // Add hover effect
                this.style.transform = 'scale(1.02)';
                this.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
                
                const messageText = messageEl.textContent;
                // Extract asset name - first word only (no spaces to avoid "Bitcoin trading at")
                const assetMatch = messageText.match(/\*\*([^*]+)\*\*|<b>([^<]+)<\/b>|^([A-Za-z&0-9]+)/);
                const assetName = assetMatch ? (assetMatch[1] || assetMatch[2] || assetMatch[3]).trim() : null;
                
                if (!assetName) return;
                
                // Set timeout to open modal after hover for 500ms
                tvModalHoverTimeout = setTimeout(() => {
                    openTradingViewModal(assetName, messageText);
                }, 500);
            });
            
            // Mouse leave - cancel timer and remove effect
            update.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1)';
                this.style.boxShadow = '';
                
                if (tvModalHoverTimeout) {
                    clearTimeout(tvModalHoverTimeout);
                    tvModalHoverTimeout = null;
                }
            });
            
            // Click - open immediately
            update.addEventListener('click', function() {
                if (tvModalHoverTimeout) {
                    clearTimeout(tvModalHoverTimeout);
                    tvModalHoverTimeout = null;
                }
                
                const messageText = messageEl.textContent;
                // Extract asset name - first word only (no spaces to avoid "Bitcoin trading at")
                const assetMatch = messageText.match(/\*\*([^*]+)\*\*|<b>([^<]+)<\/b>|^([A-Za-z&0-9]+)/);
                const assetName = assetMatch ? (assetMatch[1] || assetMatch[2] || assetMatch[3]).trim() : null;
                
                if (assetName) {
                    openTradingViewModal(assetName, messageText);
                }
            });
        });
        
        console.log('[TradingView Modal] Hover listeners initialized for', updates.length, 'updates');
    }

    // Handle window resize for chart
    window.addEventListener('resize', () => {
        if (tvModalChart) {
            const container = document.getElementById('tradingViewChartContainer');
            if (container) {
                tvModalChart.applyOptions({ 
                    width: container.clientWidth,
                    height: container.clientHeight 
                });
            }
        }
    });

    // Close modal when clicking overlay
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('tradingViewModal');
        if (modal && e.target.classList.contains('trading-view-modal-overlay')) {
            closeTradingViewModal();
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('tradingViewModal');
            if (modal && modal.classList.contains('active')) {
                closeTradingViewModal();
            }
        }
    });

    // Initialize after page load and after updates are populated
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            // Wait a bit for updates to be populated
            setTimeout(initRecentUpdatesHoverListeners, 1000);
        });
    } else {
        setTimeout(initRecentUpdatesHoverListeners, 1000);
    }

    // Reinitialize after updates are refreshed
    if (typeof updateRecentUpdatesWithRealPrices !== 'undefined') {
        const originalUpdate = updateRecentUpdatesWithRealPrices;
        updateRecentUpdatesWithRealPrices = async function() {
            await originalUpdate.apply(this, arguments);
            setTimeout(initRecentUpdatesHoverListeners, 500);
        };
    }
    </script>

    <!-- Win Rate Gauge Initialization -->
    <script>
    // Win rate gauge chart
    let winRateGaugeChart = null;
    let winRateData = {
        correct: 27,
        total: 37,
        get percentage() {
            return Math.round((this.correct / this.total) * 100);
        }
    };

    function initWinRateGauge() {
        const options = {
            series: [winRateData.percentage],
            chart: {
                type: 'radialBar',
                height: 80,
                width: 80,
                sparkline: {
                    enabled: false
                },
                background: 'transparent',
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 800,
                    animateGradually: {
                        enabled: true,
                        delay: 150
                    },
                    dynamicAnimation: {
                        enabled: true,
                        speed: 350
                    }
                }
            },
            plotOptions: {
                radialBar: {
                    hollow: {
                        size: '60%',
                        background: 'transparent'
                    },
                    track: {
                        background: 'var(--color-light)',
                        strokeWidth: '100%',
                        margin: 0,
                        opacity: 0.3
                    },
                    dataLabels: {
                        show: false
                    },
                    startAngle: -90,
                    endAngle: 90
                }
            },
            fill: {
                type: 'gradient',
                gradient: {
                    shade: 'dark',
                    type: 'horizontal',
                    shadeIntensity: 0.5,
                    gradientToColors: ['#10b981'],
                    inverseColors: false,
                    opacityFrom: 1,
                    opacityTo: 1,
                    stops: [0, 100]
                }
            },
            colors: ['#2d6cdf'],
            stroke: {
                lineCap: 'round'
            },
            grid: {
                padding: {
                    top: 0,
                    right: 0,
                    bottom: 0,
                    left: 0
                }
            }
        };

        const gaugeElement = document.querySelector('#winRateGauge');
        if (gaugeElement && !winRateGaugeChart) {
            winRateGaugeChart = new ApexCharts(gaugeElement, options);
            winRateGaugeChart.render();
        }
    }

    function updateWinRateGauge() {
        // Calculate real win rate from active positions
        if (typeof Orders !== 'undefined') {
            const activeOrders = Orders.filter(order => order.shipping === 'Active');
            let winningPositions = 0;
            
            activeOrders.forEach(order => {
                const currentPrice = order.currentPrice || (typeof getCurrentPrice !== 'undefined' ? getCurrentPrice(order.productName) : order.entryPrice);
                const pnl = (currentPrice - order.entryPrice) * order.quantity;
                const actualPnL = order.orderType === 'Long' ? pnl : -pnl;
                if (actualPnL > 0) winningPositions++;
            });
            
            winRateData.correct = winningPositions;
            winRateData.total = activeOrders.length;
        }
        
        const percentage = winRateData.percentage;
        
        // Update the gauge
        if (winRateGaugeChart) {
            winRateGaugeChart.updateSeries([percentage]);
        }
        
        // Update the main value display
        const valueElement = document.getElementById('winRateValue');
        if (valueElement) {
            valueElement.textContent = percentage + '%';
            // Update the data attribute for live updates
            valueElement.setAttribute('data-base-value', (percentage / 100).toFixed(2));
        }
        
        // Update the stats display
        const statsElement = document.getElementById('winRateStats');
        if (statsElement) {
            statsElement.textContent = `${winRateData.correct}/${winRateData.total}`;
        }
    }

    // Initialize gauge when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initWinRateGauge, 500);
        });
    } else {
        setTimeout(initWinRateGauge, 500);
    }

    // Update win rate gauge every 30 seconds
    setInterval(updateWinRateGauge, 30000);
    </script>
    
</body>
</html>