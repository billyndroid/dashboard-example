<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp"
      rel="stylesheet">
      <link rel="stylesheet" href="../styles/style.css">
</head>
<body>
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <div class="container">
        <aside class="top">
            <div class="logo">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="48" height="48" role="img" aria-labelledby="logoTitle logoDesc">
                  <title id="logoTitle">SQU^RE DOFF Trading Dashboard</title>
                  <desc id="logoDesc">Square logo with an upward trending chart line indicating market performance.</desc>
                  <g opacity="0.08" fill="none" class="logo-grid" stroke-width="0.8">
                    <path d="M10 48 L54 48" />
                    <path d="M10 36 L54 36" />
                    <path d="M10 24 L54 24" />
                    <path d="M22 10 L22 54" />
                    <path d="M34 10 L34 54" />
                    <path d="M46 10 L46 54" />
                  </g>
                  <rect x="12" y="36" width="6" height="10" rx="1" class="logo-bar" opacity="0.18" />
                  <rect x="22" y="30" width="6" height="16" rx="1" class="logo-bar" opacity="0.22" />
                  <rect x="32" y="22" width="6" height="24" rx="1" class="logo-bar-active" />
                  <rect x="42" y="16" width="6" height="30" rx="1" class="logo-bar" opacity="0.18" />
                  <polyline points="12,42 20,34 28,26 36,20 44,16" fill="none" class="logo-line" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
                  <circle cx="44" cy="16" r="3.2" class="logo-accent" />
                </svg>
                <h2>SQU^RE<span class="danger">DOFF</span></h2>
            </div>
            <div class="close" id="close-btn" role="button" aria-label="Close sidebar" tabindex="0">
                <span class="material-icons-sharp" aria-hidden="true">close</span>
            </div>

            <nav class="sidebar" role="navigation" aria-label="Main navigation">
                <a href="../index.html">
                    <span class="material-icons-sharp">grid_view</span>
                    <h3>Dashboard</h3>
                </a>

                <a href="customers.html">
                    <span class="material-icons-sharp">person_outline</span>
                    <h3>Customers</h3>
                </a>

                <a href="orders.html">
                    <span class="material-icons-sharp">receipt_long</span>
                    <h3>Orders</h3>
                </a>

                <a href="analytics.html">
                    <span class="material-icons-sharp">insights</span>
                    <h3>Analytics</h3>
                </a>

                <a href="messages.html">
                    <span class="material-icons-sharp">mail_outline</span>
                    <h3>Messages</h3>
                    <span class="message-count">21</span>
                </a>

                <a href="products.html">
                    <span class="material-icons-sharp">inventory</span>
                    <h3>Products</h3>
                </a>

                <a href="reports.html">
                    <span class="material-icons-sharp">error</span>
                    <h3>Reports</h3>
                </a>

                <a href="settings.html">
                    <span class="material-icons-sharp">settings</span>
                    <h3>Settings</h3>
                </a>

                <a href="#">
                    <span class="material-icons-sharp">add</span>
                    <h3>Add Commodity</h3>
                </a>

                <a href="#">
                    <span class="material-icons-sharp">logout</span>
                    <h3>Logout</h3>
                </a>
            </nav>

        </aside>

        <main id="main-content" role="main" aria-label="Analytics content">
            <h1>Market Analytics</h1>
            <div class="date" role="group" aria-label="Date range selection">
                <input type="date" id="startDate" aria-label="Start date">
                <span style="margin: 0 0.5rem;">to</span>
                <input type="date" id="endDate" aria-label="End date">
                <button class="btn btn-primary" id="applyDateRange" style="margin-left: 1rem;" aria-label="Apply selected date range">Apply</button>
                <select id="presetRanges" class="btn btn-outline" style="margin-left: 0.5rem;" aria-label="Quick date range presets">
                    <option value="">Quick Ranges</option>
                    <option value="7">Last 7 Days</option>
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                </select>
            </div>

            <!--Trading Volume Chart-------------------------------------------------------------------------------------------->
            <div style="margin: 20px 0;">
                <h2>Trading Volume Analysis</h2>
                <div id="volumeChart"></div>
            </div>

            <!--Price Movement Chart-------------------------------------------------------------------------------------------->
            <div style="margin: 20px 0;">
                <h2>Price Movement Trends</h2>
                <div id="priceChart"></div>
            </div>

            <!--Historical Price Chart-------------------------------------------------------------------------------------------->
            <div style="margin: 20px 0;">
                <h2>Historical Price Trends</h2>
                <div id="historicalChart"></div>
            </div>
        </main>

        <div class="right">
            <div class="top">
                <button id="menu-btn">
                    <span class="material-icons-sharp">menu</span>
                </button>
                <div class="theme-toggler">
                    <span class="material-icons-sharp active">light_mode</span>
                    <span class="material-icons-sharp">dark_mode</span>
                </div>
                <div class="profile">
                    <div class="info">
                        <p>Key: <b>Gavin</b></p>
                        <small class="text-muted">Admin</small>
                    </div>
                    <div class="profile-pic">
                        <img src="../assets/profile-pic-1.png" height="50px" width="50px">
                    </div>
                </div>
            </div>

            <div class="recent-updates">
                <h2>Analytics Updates</h2>
                <div class="updates">
                    <div class="update">
                        <div class="profile-photo">
                            <img src="../assets/profile-pic-1.png">
                        </div>
                        <div class="message">
                            <p><b>Volume Analysis</b> updated with latest data</p>
                            <small class="text-muted">2 minutes ago</small>
                        </div>
                    </div>
                    <div class="update">
                        <div class="profile-photo">
                            <img src="../assets/profile-pic-2.png">
                        </div>
                        <div class="message">
                            <p><b>Price Trends</b> showing bullish signals</p>
                            <small class="text-muted">15 minutes ago</small>
                        </div>
                    </div>
                    <div class="update">
                        <div class="profile-photo">
                            <img src="../assets/profile-pic-3.png">
                        </div>
                        <div class="message">
                            <p><b>Market Summary</b> report generated</p>
                            <small class="text-muted">1 hour ago</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sales-analytics">
                <h2>Quick Stats</h2>
                <div class="item online">
                    <div class="icon">
                        <span class="material-icons-sharp">trending_up</span>
                    </div>
                    <div class="right">
                        <div class="info">
                            <h3>Market Trend</h3>
                            <small class="text-muted">Overall Bullish</small>
                        </div>
                        <h5 class="success">+2.4%</h5>
                    </div>
                </div>
                <div class="item customers">
                    <div class="icon">
                        <span class="material-icons-sharp">show_chart</span>
                    </div>
                    <div class="right">
                        <div class="info">
                            <h3>Volume</h3>
                            <small class="text-muted">Trading Activity</small>
                        </div>
                        <h5 class="success">High</h5>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
<script src="../scripts/config.js"></script>
<script src="../scripts/data-service.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
// Initialize data
let marketData = null;
let volumeChart = null;
let priceChart = null;
let historicalChart = null;
let currentDateRange = { start: null, end: null };

// Set default date range (last 30 days)
function setDefaultDateRange() {
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
    
    currentDateRange = {
        start: thirtyDaysAgo.toISOString().split('T')[0],
        end: today.toISOString().split('T')[0]
    };
}

// Load and render all charts
function loadChartData() {
    if (!window.DataService) {
        console.error('DataService not loaded');
        return;
    }
    
    // Get market data for major assets
    const assets = ['S&P 500', 'NASDAQ', 'FTSE', 'Oil', 'Gold', 'Natural Gas', 'Silver', 'Bitcoin', 'Ethereum'];
    const days = currentDateRange.start && currentDateRange.end ? 
        Math.ceil((new Date(currentDateRange.end) - new Date(currentDateRange.start)) / (1000 * 60 * 60 * 24)) : 30;
    
    marketData = DataService.getMarketData(assets, days);
    
    // Update volume chart
    const volumeData = DataService.aggregateVolumeData(marketData);
    updateVolumeChart(volumeData);
    
    // Update price change chart
    const priceData = DataService.getPriceChanges(marketData);
    updatePriceChart(priceData);
    
    // Update historical chart
    updateHistoricalChart(marketData);
}

// Volume Chart
function updateVolumeChart(volumeData) {
    const options = {
        chart: {
            type: 'bar',
            height: 350,
            toolbar: {
                show: true,
                tools: {
                    download: true,
                    selection: false,
                    zoom: false,
                    zoomin: false,
                    zoomout: false,
                    pan: false,
                    reset: false
                }
            }
        },
        series: [{
            name: 'Trading Volume',
            data: volumeData.data
        }],
        xaxis: {
            categories: volumeData.categories,
            labels: {
                rotate: -45,
                rotateAlways: false
            }
        },
        yaxis: {
            labels: {
                formatter: function(val) {
                    return (val / 1000).toFixed(0) + 'K';
                }
            }
        },
        colors: ['#2d6cdf'],
        title: {
            text: 'Total Trading Volume by Asset',
            style: {
                fontSize: '16px',
                fontWeight: 600
            }
        },
        dataLabels: {
            enabled: false
        },
        responsive: [{
            breakpoint: 768,
            options: {
                chart: {
                    height: 300
                },
                xaxis: {
                    labels: {
                        rotate: -45,
                        rotateAlways: true
                    }
                }
            }
        }]
    };
    
    if (volumeChart) {
        volumeChart.updateOptions(options);
    } else {
        volumeChart = new ApexCharts(document.querySelector("#volumeChart"), options);
        volumeChart.render();
    }
}

// Price Chart
function updatePriceChart(priceData) {
    const options = {
        chart: {
            type: 'line',
            height: 350,
            toolbar: {
                show: true,
                tools: {
                    download: true,
                    selection: false,
                    zoom: false,
                    zoomin: false,
                    zoomout: false,
                    pan: false,
                    reset: false
                }
            }
        },
        series: [{
            name: 'Price Change %',
            data: priceData.data
        }],
        xaxis: {
            categories: priceData.categories,
            labels: {
                rotate: -45,
                rotateAlways: false
            }
        },
        yaxis: {
            labels: {
                formatter: function(val) {
                    return val.toFixed(1) + '%';
                }
            }
        },
        colors: ['#10b981'],
        title: {
            text: 'Price Change Percentage',
            style: {
                fontSize: '16px',
                fontWeight: 600
            }
        },
        stroke: {
            curve: 'smooth',
            width: 3
        },
        markers: {
            size: 5,
            colors: ['#10b981'],
            strokeColors: '#fff',
            strokeWidth: 2,
            hover: {
                size: 7
            }
        },
        responsive: [{
            breakpoint: 768,
            options: {
                chart: {
                    height: 300
                },
                xaxis: {
                    labels: {
                        rotate: -45,
                        rotateAlways: true
                    }
                }
            }
        }]
    };
    
    if (priceChart) {
        priceChart.updateOptions(options);
    } else {
        priceChart = new ApexCharts(document.querySelector("#priceChart"), options);
        priceChart.render();
    }
}

// Historical Price Chart
function updateHistoricalChart(marketData) {
    // Get top 5 assets for historical view
    const topAssets = Object.keys(marketData).slice(0, 5);
    const series = topAssets.map(asset => {
        const data = marketData[asset];
        return {
            name: asset,
            data: data.map(d => ({
                x: new Date(d.date).getTime(),
                y: d.price
            }))
        };
    });
    
    const options = {
        chart: {
            type: 'line',
            height: 400,
            zoom: {
                enabled: true
            },
            toolbar: {
                show: true
            }
        },
        series: series,
        xaxis: {
            type: 'datetime',
            labels: {
                datetimeUTC: false,
                format: 'MMM dd'
            }
        },
        yaxis: {
            labels: {
                formatter: function(val) {
                    return '$' + val.toFixed(0);
                }
            }
        },
        title: {
            text: 'Historical Price Comparison',
            style: {
                fontSize: '16px',
                fontWeight: 600
            }
        },
        stroke: {
            curve: 'smooth',
            width: 2
        },
        dataLabels: {
            enabled: false
        },
        legend: {
            position: 'top',
            horizontalAlign: 'left'
        },
        tooltip: {
            x: {
                format: 'MMM dd, yyyy'
            }
        },
        responsive: [{
            breakpoint: 768,
            options: {
                chart: {
                    height: 300
                },
                legend: {
                    position: 'bottom'
                }
            }
        }]
    };
    
    if (historicalChart) {
        historicalChart.updateOptions(options);
    } else {
        historicalChart = new ApexCharts(document.querySelector("#historicalChart"), options);
        historicalChart.render();
    }
}

// Date range handlers
document.getElementById('applyDateRange').addEventListener('click', function() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (startDate && endDate) {
        currentDateRange = { start: startDate, end: endDate };
        loadChartData();
        
        // Show notification if available
        if (window.showNotification) {
            showNotification('Charts updated for selected date range', 'success');
        }
    }
});

// Preset range selector
document.getElementById('presetRanges').addEventListener('change', function(e) {
    const days = parseInt(e.target.value);
    if (!days) return;
    
    const today = new Date();
    const startDate = new Date(today);
    startDate.setDate(startDate.getDate() - days);
    
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
    
    currentDateRange = {
        start: startDate.toISOString().split('T')[0],
        end: today.toISOString().split('T')[0]
    };
    
    loadChartData();
    e.target.value = ''; // Reset selector
});

// Initialize
setDefaultDateRange();
loadChartData();

// Auto-refresh every 5 minutes
setInterval(() => {
    loadChartData();
    console.log('Charts data refreshed');
}, 5 * 60 * 1000);
</script>

<script src="../scripts/error-handler.js"></script>
<script src="../scripts/security-utils.js"></script>
<script src="../scripts/performance-utils.js"></script>
<script src="../scripts/main.js"></script>
</body>
</html>